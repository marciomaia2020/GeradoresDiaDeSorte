<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dia de Sorte Conferidor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Cores oficiais do Dia de Sorte */
            --dia-sorte-verde: #00722E;
            --dia-sorte-verde-claro: #008a37;
            --dia-sorte-dourado: #D9B13B;
            --dia-sorte-claro: #E6D089;
            --dia-sorte-escuro: #005423;
            --dia-sorte-bg: #F5F0E1;
            --vermelho: #dc3545;
            --text-primary: #333;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--dia-sorte-bg);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--dia-sorte-verde);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 28px;
        }

        h2 {
            color: var(--dia-sorte-verde);
            font-size: 1.5rem;
            margin: 1rem 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--dia-sorte-dourado);
        }

        h3 {
            font-size: 1.2rem;
            margin: 15px 0 10px 0;
            color: var(--dia-sorte-verde);
        }
        
        /* Estilos do Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--dia-sorte-dourado);
            margin-bottom: 15px;
        }
        
        .modal-header i {
            font-size: 24px;
            color: var(--dia-sorte-dourado);
            margin-right: 10px;
        }
        
        .modal-header h2 {
            color: var(--dia-sorte-verde);
            margin: 0;
            border-bottom: none;
        }
        
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--dia-sorte-verde);
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section h3 {
            color: var(--dia-sorte-verde);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .info-section ul {
            list-style-type: none;
            padding-left: 10px;
        }
        
        .info-section ul li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
        }
        
        .info-section ul li i {
            color: var(--dia-sorte-dourado);
            margin-right: 10px;
            margin-top: 4px;
        }
        
        .info-section ul ul {
            margin-top: 10px;
            margin-left: 25px;
        }
        
        .info-section ul ul li {
            margin-bottom: 5px;
        }

        /* Volante */
        .volante {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--dia-sorte-bg);
            border-radius: 8px;
            border: 1px solid var(--dia-sorte-verde);
        }

        .numeros {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .numero {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid var(--border-color);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .numero:hover {
            transform: scale(1.05);
            background-color: #f0f0f0;
        }

        .numero.selecionado {
            background-color: var(--dia-sorte-verde);
            color: white;
            border-color: var(--dia-sorte-verde);
        }

        .meses {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .mes {
            padding: 8px 0;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mes:hover {
            background-color: #f0f0f0;
        }

        .mes.selecionado {
            background-color: var(--dia-sorte-verde);
            color: white;
            border-color: var(--dia-sorte-verde);
        }

        /* Análise de dígitos */
        .digitos-analise {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--dia-sorte-bg);
            border-radius: 5px;
            display: none;
        }

        .digitos-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .digito-tile {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            background-color: #e9e9e9;
        }

        .digito-presente {
            background-color: var(--dia-sorte-dourado);
            color: #333;
        }

        .digito-quantidade {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--dia-sorte-verde);
            background-color: rgba(217, 177, 59, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
        }

        /* Drop zone */
        .drop-zone {
            width: 100%;
            height: 150px;
            border: 3px dashed var(--dia-sorte-verde);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            cursor: pointer;
            background-color: rgba(0, 114, 46, 0.05);
            transition: all 0.3s;
        }

        .drop-zone:hover {
            background-color: rgba(0, 114, 46, 0.1);
        }

        .drop-zone.dragover {
            background-color: rgba(0, 114, 46, 0.2);
            border-color: var(--dia-sorte-dourado);
        }

        .drop-zone-content {
            text-align: center;
        }

        .drop-zone-hint {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
        }

        /* Controles */
        .controles {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .input-group {
            flex: 1;
            min-width: 180px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 25px;
        }

        .checkbox-group label {
            margin-left: 8px;
            font-weight: 600;
        }

        /* Botões */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-info {
            background-color: var(--dia-sorte-verde);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .btn-info:hover {
            background-color: var(--dia-sorte-escuro);
        }
        
        .btn-dourado {
            background-color: var(--dia-sorte-dourado);
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .btn-dourado:hover {
            background-color: var(--dia-sorte-claro);
        }
        
        .info-banner {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .acoes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .btn-azul {
            background-color: var(--dia-sorte-verde);
            color: white;
        }

        .btn-azul:hover {
            background-color: var(--dia-sorte-verde-claro);
        }

        .btn-vermelho {
            background-color: var(--vermelho);
            color: white;
        }

        .btn-vermelho:hover {
            background-color: #c82333;
        }

        .btn-roxo {
            background-color: var(--dia-sorte-dourado);
            color: #333;
        }

        .btn-roxo:hover {
            background-color: var(--dia-sorte-claro);
        }

        .btn-verde {
            background-color: var(--dia-sorte-verde);
            color: white;
        }

        .btn-verde:hover {
            background-color: var(--dia-sorte-verde-claro);
        }

        /* Jogos incluídos */
        .jogos-incluidos {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .jogo-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 8px;
            background-color: #f8f8f8;
            border-radius: 4px;
            border-left: 3px solid var(--dia-sorte-verde);
        }

        .jogo-item:hover {
            background-color: #f0f0f0;
        }

        .jogo-item.selecionado {
            background-color: rgba(0, 114, 46, 0.1);
            border-left-color: var(--dia-sorte-dourado);
        }

        .jogo-checkbox {
            margin-right: 10px;
        }
        
        .jogo-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .jogo-numeros {
            display: flex;
            align-items: center;
        }
        
        .jogo-numero {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            background-color: #f0f0f0;
            margin-right: 3px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .jogo-mes {
            margin-left: 8px;
            color: #777;
        }
        
        .jogo-digitos {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .jogo-botoes {
            display: flex;
            gap: 5px;
        }
        
        .btn-remover {
            margin-left: auto;
            padding: 4px 8px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-remover:hover {
            background-color: #c82333;
        }
        
        .btn-analisar {
            padding: 4px 8px;
            margin-right: 5px;
            background-color: var(--dia-sorte-dourado);
            color: #333;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-analisar:hover {
            background-color: var(--dia-sorte-claro);
        }

        .acoes-jogos {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn-acao {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-acao:hover:not(:disabled) {
            background-color: #e0e0e0;
        }

        .btn-acao:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Overlay e progresso */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .progress {
            width: 90%;
            max-width: 500px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 20px;
            text-align: center;
        }
        
        .progress h3 {
            color: var(--dia-sorte-verde);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--dia-sorte-dourado);
            text-align: center;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid #ddd;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: var(--dia-sorte-verde);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill.animando::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg, 
                rgba(255,255,255,0) 0%, 
                rgba(255,255,255,0.3) 50%, 
                rgba(255,255,255,0) 100%
            );
            animation: progress-shine 1.5s linear infinite;
        }
        
        @keyframes progress-shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            font-weight: bold;
            color: var(--dia-sorte-verde);
            margin: 10px 0;
            text-align: center;
        }
        
        .progress-logs {
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .log-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .log-time {
            font-family: monospace;
            color: #6c757d;
            margin-right: 5px;
        }
        
        .lote-info {
            background-color: #f0f8f0;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid var(--dia-sorte-verde);
            font-size: 14px;
        }
        
        .btn-danger {
            display: block;
            margin: 15px auto 0;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Resultados */
        .resultados {
            margin-top: 30px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .card {
            background-color: var(--dia-sorte-bg);
            border: 1px solid var(--dia-sorte-dourado);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .contagem {
            font-size: 24px;
            font-weight: bold;
            color: var(--dia-sorte-verde);
            margin: 10px 0;
        }

        .valor-premio {
            color: #333;
            font-weight: 600;
        }

        /* Tabelas */
        .tabela-resumo, .jogos-mais-sorteados {
            margin-top: 30px;
        }

        .tabela-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        .tabela-premios {
            width: 100%;
            border-collapse: collapse;
        }

        .tabela-premios th, .tabela-premios td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .tabela-premios th {
            background-color: var(--dia-sorte-verde);
            color: white;
        }

        .tabela-premios tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .acerto {
            font-weight: bold;
            color: var(--dia-sorte-verde);
        }

        .numeros-tabela {
            white-space: nowrap;
            letter-spacing: 1px;
        }
        
        .numero-tabela {
            display: inline-block;
            margin-right: 4px;
        }
        
        .acerto-mes {
            color: var(--dia-sorte-dourado);
            font-weight: bold;
            margin-left: 5px;
        }

        /* Botões de exportação */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .btn-export {
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: var(--dia-sorte-verde);
            color: white !important;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-export:hover {
            background-color: var(--dia-sorte-verde-claro);
        }
        
        .btn-export i {
            font-size: 16px;
        }

        /* Animações */
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }

        /* Utilitários */
        .hidden {
            display: none !important;
        }

        /* Media queries */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .numeros {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .meses {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .digitos-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .progress {
                width: 95%;
                padding: 15px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .numeros {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .meses {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cards {
                grid-template-columns: 1fr;
            }
            
            .acoes {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        @media print {
            .no-print {
                display: none;
            }
            
            body {
                background: white;
            }
            
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Informações -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-header">
                <i class="fas fa-info-circle"></i>
                <h2>Informações Importantes</h2>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3>Para os Jogos:</h3>
                    <ul>
                        <li><i class="fas fa-check-circle"></i> Você pode carregar quantos jogos quiser (20 mil, 80 mil, 100 mil...)</li>
                        <li><i class="fas fa-check-circle"></i> Não há limite para quantidade de jogos</li>
                        <li><i class="fas fa-check-circle"></i> Todos os jogos serão verificados em cada lote</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h3>Para os Concursos:</h3>
                    <ul>
                        <li><i class="fas fa-info-circle"></i> O sistema processa em lotes de 50 concursos</li>
                        <li><i class="fas fa-info-circle"></i> Por exemplo, se você quiser verificar do concurso 1 até o último:
                            <ul>
                                <li>Lote 1: concursos 1-50</li>
                                <li>Lote 2: concursos 51-100</li>
                                <li>E assim por diante...</li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="info-section">
                    <h3>Sobre o Funcionamento:</h3>
                    <ul>
                        <li><i class="fas fa-info-circle"></i> Esta versão funciona diretamente no navegador sem necessidade de servidor</li>
                        <li><i class="fas fa-info-circle"></i> Os resultados são obtidos da API oficial de loterias da Caixa</li>
                        <li><i class="fas fa-info-circle"></i> Os resultados são armazenados em cache no seu navegador para consultas mais rápidas</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modal-close-btn" class="btn btn-dourado">Entendi</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Conferidor Dia de Sorte</h1>
        <div class="info-banner">
            <button id="open-info-modal" class="btn btn-info">
                <i class="fas fa-info-circle"></i> Informações Importantes
            </button>
        </div>

        <div class="volante">
            <h2>Selecione 7 números</h2>
            <div class="numeros" id="numeros-container">
                <!-- Números serão adicionados via JavaScript -->
            </div>

            <div class="meses-container">
                <h2>Selecione o Mês da Sorte</h2>
                <div class="meses" id="meses-container">
                    <!-- Meses serão adicionados via JavaScript -->
                </div>
            </div>
            
            <!-- Análise de dígitos do palpite -->
            <div class="digitos-analise" id="digitos-analise">
                <h3>Análise de Dígitos</h3>
                <p>Dígitos utilizados: <span id="contador-digitos" class="digito-quantidade">0</span> dígitos</p>
                <div class="digitos-grid" id="digitos-grid">
                    <!-- Dígitos serão adicionados via JavaScript -->
                </div>
            </div>
        </div>

        <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-content">
                <p>Arraste e solte seu arquivo aqui ou clique para selecionar</p>
                <p class="drop-zone-hint">Arquivos .txt ou .xlsx</p>
                <input type="file" id="file-input" accept=".txt,.xlsx" hidden>
            </div>
        </div>

        <div class="controles">
            <div class="input-group">
                <label for="inicio">Concurso Inicial:</label>
                <input type="number" id="inicio" min="1" value="1">
            </div>
            <div class="input-group">
                <label for="fim">Concurso Final:</label>
                <input type="number" id="fim" min="1" placeholder="Último concurso">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="somente-premiados">
                <label for="somente-premiados">Somente premiados</label>
            </div>
        </div>

        <div class="acoes">
            <button id="incluir" class="btn btn-azul">Incluir Jogo</button>
            <button id="limpar" class="btn btn-vermelho">Limpar</button>
            <button id="sugestao" class="btn btn-roxo">Palpite</button>
            <button id="conferir" class="btn btn-verde">Conferir</button>
        </div>

        <div class="jogos-incluidos">
            <h3>Jogos Incluídos (<span id="contador-jogos">0</span> jogos)</h3>
            <div id="lista-jogos" class="lista-jogos"></div>
        </div>

        <div class="acoes-jogos">
            <button id="btn-remover-selecionados" class="btn-acao" disabled>
                Remover Selecionados
            </button>
            <button id="btn-limpar-todos" class="btn-acao">
                Limpar Todos
            </button>
        </div>

        <!-- Overlay para visualização do progresso em tempo real -->
        <div id="overlay" class="overlay" style="display: none;">
            <div class="progress">
                <h3>Processando Jogos</h3>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Preparando para processar jogos...</div>
                <div id="lote-info" class="lote-info">
                    <div class="lote-atual">
                        Lote: <span id="lote-atual">0</span> de <span id="total-lotes">0</span>
                    </div>
                    <div class="concursos-range">
                        Concursos: <span id="concurso-atual">0</span> a <span id="concurso-fim">0</span>
                    </div>
                </div>
                <div id="progress-logs" class="progress-logs"></div>
                <button id="btn-cancelar-conferencia" class="btn btn-danger">
                    Cancelar Conferência
                </button>
            </div>
        </div>

        <div class="resultados" id="resultados" style="display: none;">
            <h2>Resumo de acertos</h2>
            <div class="export-buttons hidden" id="export-resumo">
                <button onclick="exportarExcel('resumo-acertos')" class="btn-export">
                    <i class="fas fa-file-excel"></i> Exportar para Excel
                </button>
            </div>
            <div class="cards">
                <div class="card">
                    <h3>4 Acertos</h3>
                    <p class="contagem" id="quatro-acertos">0</p>
                    <p class="valor-premio" id="quatro-valor">R$ 0,00</p>
                </div>
                <div class="card">
                    <h3>5 Acertos</h3>
                    <p class="contagem" id="cinco-acertos">0</p>
                    <p class="valor-premio" id="cinco-valor">R$ 0,00</p>
                </div>
                <div class="card">
                    <h3>6 Acertos</h3>
                    <p class="contagem" id="seis-acertos">0</p>
                    <p class="valor-premio" id="seis-valor">R$ 0,00</p>
                </div>
                <div class="card">
                    <h3>7 Acertos</h3>
                    <p class="contagem" id="sete-acertos">0</p>
                    <p class="valor-premio" id="sete-valor">R$ 0,00</p>
                </div>
            </div>

            <div class="card mes-card">
                <h3>Mês da Sorte</h3>
                <p class="contagem" id="mes-acertos">0</p>
                <p class="valor-premio" id="mes-valor">R$ 0,00</p>
            </div>

            <div id="detalhes-resultados" class="detalhes-resultados"></div>

            <div class="tabela-resumo">
                <h2>Resumo dos Jogos Premiados</h2>
                <div class="export-buttons hidden" id="export-jogos">
                    <button onclick="exportarExcel('jogos-premiados')" class="btn-export">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                </div>
                <div class="tabela-container">
                    <table class="tabela-premios">
                        <thead>
                            <tr>
                                <th>Concurso</th>
                                <th>Data</th>
                                <th>Números Sorteados</th>
                                <th>Mês Sorteado</th>
                                <th>Seu Jogo</th>
                                <th>Seu Mês</th>
                                <th>Acertos</th>
                                <th>Dígitos Usados</th>
                                <th>Prêmio</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-resultados">
                            <!-- Será preenchido via JavaScript -->
                        </tbody>
                        <tfoot id="tabela-totais">
                            <tr>
                                <td colspan="8"><strong>Total de Prêmios</strong></td>
                                <td colspan="2" class="total-premios">R$ 0,00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="jogos-mais-sorteados" id="jogos-mais-sorteados" style="display: none;">
                <h2>Jogos Mais Sorteados</h2>
                <div class="export-buttons hidden" id="export-estatisticas">
                    <button onclick="exportarExcel('jogos-sorteados')" class="btn-export">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                </div>
                
                <div class="tabela-container">
                    <table class="tabela-premios" id="tabela-jogos-sorteados">
                        <thead>
                            <tr>
                                <th>Meu Jogo</th>
                                <th>Total de Acertos</th>
                                <th>Distribuição</th>
                                <th>Acertos do Mês</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Será preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Constantes
            const MESES = [
                "JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO",
                "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"
            ];
            const TAMANHO_LOTE = 30; // Reduzido para melhor desempenho no navegador
            const API_URLS = [
                "https://loteriascaixa-api.herokuapp.com/api/diadesorte",  // API principal
                "https://servicebus2.caixa.gov.br/portaldeloterias/api/diadesorte" // API alternativa
            ];
            
            // Variáveis globais
            const jogosIncluidos = [];
            const jogosSelecionados = new Set();
            const numerosSelecionados = new Set();
            const resultadosCache = {};
            let conferenciaCancelada = false;
            let dadosUltimaConsulta = null;
            let mesSelecionado = null;
            let ultimoConcurso = 500; // Valor padrão, será atualizado
            let apiFailureCount = 0; // Contador para falhas consecutivas na API
            
            // Carregar cache do localStorage
            carregarCache();
            
            // Inicializar a interface
            inicializarInterface();
            buscarUltimoConcurso();
            
            // ===== FUNÇÕES DE INICIALIZAÇÃO =====
            
            function inicializarInterface() {
                // Inicializar volante
                inicializarVolante();
                
                // Inicializar modal de informações
                setupModal();
                
                // Inicializar drag and drop
                setupDragAndDrop();
                
                // Inicializar botões
                setupBotoes();
                
                // Inicializar eventos de jogos
                setupEventosJogos();
                
                // Inicializar overlay de progresso
                setupOverlay();
            }
            
            function inicializarVolante() {
                // Adicionar números ao volante
                const numerosContainer = document.getElementById('numeros-container');
                for (let i = 1; i <= 31; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'numero';
                    btn.dataset.numero = i;
                    btn.textContent = String(i).padStart(2, '0');
                    btn.addEventListener('click', function() {
                        const num = parseInt(this.dataset.numero);
                        if (this.classList.contains('selecionado')) {
                            this.classList.remove('selecionado');
                            numerosSelecionados.delete(num);
                        } else if (numerosSelecionados.size < 7) {
                            this.classList.add('selecionado');
                            numerosSelecionados.add(num);
                        } else {
                            alert('Você já selecionou 7 números!');
                            return;
                        }
                        
                        analisarDigitos();
                    });
                    numerosContainer.appendChild(btn);
                }
                
                // Adicionar meses ao volante
                const mesesContainer = document.getElementById('meses-container');
                MESES.forEach(mes => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'mes';
                    btn.dataset.mes = mes;
                    btn.textContent = mes;
                    btn.addEventListener('click', function() {
                        const mesValor = this.dataset.mes;
                        const meses = document.querySelectorAll('.mes');
                        meses.forEach(m => m.classList.remove('selecionado'));
                        
                        if (mesValor === mesSelecionado) {
                            mesSelecionado = null;
                        } else {
                            this.classList.add('selecionado');
                            mesSelecionado = mesValor;
                        }
                    });
                    mesesContainer.appendChild(btn);
                });
                
                // Inicializar grid de dígitos
                const digitosGrid = document.getElementById('digitos-grid');
                for (let i = 0; i < 10; i++) {
                    const digito = document.createElement('div');
                    digito.id = `digito-${i}`;
                    digito.className = 'digito-tile';
                    digito.textContent = i;
                    digitosGrid.appendChild(digito);
                }
            }
            
            function setupModal() {
                const modal = document.getElementById('info-modal');
                const openModalBtn = document.getElementById('open-info-modal');
                const closeModalBtn = document.querySelector('.close-modal');
                const modalCloseBtn = document.getElementById('modal-close-btn');
                
                // Abrir modal
                openModalBtn.addEventListener('click', () => {
                    modal.style.display = 'block';
                });
                
                // Fechar modal
                closeModalBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                modalCloseBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                // Fechar modal clicando fora
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
                
                // Mostrar modal na primeira visita
                const primeiraVisita = !localStorage.getItem('visitouDiaDeSorte');
                if (primeiraVisita) {
                    modal.style.display = 'block';
                    localStorage.setItem('visitouDiaDeSorte', 'true');
                }
            }
            
            function setupDragAndDrop() {
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                
                dropZone.onclick = () => fileInput.click();
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('dragover');
                    });
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('dragover');
                    });
                });
                
                dropZone.addEventListener('drop', handleDrop);
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            function setupBotoes() {
                const limparBtn = document.getElementById('limpar');
                const sugestaoBtn = document.getElementById('sugestao');
                const conferirBtn = document.getElementById('conferir');
                const incluirBtn = document.getElementById('incluir');
                
                // Botão Limpar
                limparBtn.addEventListener('click', () => {
                    document.querySelectorAll('.numero').forEach(numero => numero.classList.remove('selecionado'));
                    numerosSelecionados.clear();
                    document.querySelectorAll('.mes').forEach(mes => mes.classList.remove('selecionado'));
                    mesSelecionado = null;
                    
                    // Ocultar análise de dígitos
                    document.getElementById('digitos-analise').style.display = 'none';
                });
                
                // Botão Sugestão
                sugestaoBtn.addEventListener('click', () => {
                    // Limpar seleções atuais
                    limparBtn.click();
                    
                    // Gerar números aleatórios
                    const numeros = gerarNumerosAleatorios(1, 31, 7);
                    numeros.forEach(num => {
                        const numeroElement = document.querySelector(`.numero[data-numero="${num}"]`);
                        if (numeroElement) {
                            numeroElement.classList.add('selecionado');
                            numerosSelecionados.add(num);
                        }
                    });
                    
                    // Selecionar mês aleatório
                    const mesAleatorio = MESES[Math.floor(Math.random() * MESES.length)];
                    const mesElement = document.querySelector(`.mes[data-mes="${mesAleatorio}"]`);
                    if (mesElement) {
                        mesElement.classList.add('selecionado');
                        mesSelecionado = mesAleatorio;
                    }
                    
                    // Analisar dígitos
                    analisarDigitos();
                });
                
                // Botão Incluir
                incluirBtn.addEventListener('click', () => {
                    if (numerosSelecionados.size !== 7) {
                        alert(`Selecione 7 números antes de incluir o jogo! (Selecionados: ${numerosSelecionados.size})`);
                        return;
                    }
                    
                    const numerosArray = Array.from(numerosSelecionados).sort((a, b) => a - b);
                    const novoJogo = {
                        numeros: numerosArray,
                        mes: mesSelecionado
                    };
                    
                    jogosIncluidos.push(novoJogo);
                    adicionarJogoNaLista(novoJogo);
                    atualizarContadorJogos();
                    alert('1 jogo foi incluído com sucesso!');
                    
                    // Limpar seleções
                    limparBtn.click();
                });
                
                // Botão Conferir
                conferirBtn.addEventListener('click', () => {
                    iniciarConferencia();
                });
            }
            
            function setupEventosJogos() {
                document.getElementById('btn-limpar-todos').addEventListener('click', limparTodosJogos);
                document.getElementById('btn-remover-selecionados').addEventListener('click', removerJogosSelecionados);
            }
            
            function setupOverlay() {
                const btnCancelarConferencia = document.getElementById('btn-cancelar-conferencia');
                btnCancelarConferencia.addEventListener('click', () => {
                    conferenciaCancelada = true;
                    document.getElementById('overlay').style.display = 'none';
                    document.title = 'Dia de Sorte Conferidor';
                });
            }
            
            // ===== FUNÇÕES DE MANIPULAÇÃO DE JOGOS =====
            
            function atualizarContadorJogos() {
                const quantidade = jogosIncluidos.length;
                document.getElementById('contador-jogos').textContent = quantidade;
                document.querySelector('.jogos-incluidos h3').textContent = 
                    `Jogos Incluídos (${quantidade} ${quantidade === 1 ? 'jogo' : 'jogos'})`;
            }
            
            function adicionarJogoNaLista(jogo) {
                const listaJogos = document.getElementById('lista-jogos');
                const jogoItem = document.createElement('div');
                jogoItem.className = 'jogo-item';
                
                // Análise de dígitos do jogo
                const analiseDigitos = extrairDigitosUnicos(jogo.numeros);
                
                // Checkbox para seleção
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'jogo-checkbox';
                checkbox.addEventListener('click', (e) => {
                    const jogoStr = JSON.stringify(jogo);
                    if (e.target.checked) {
                        jogosSelecionados.add(jogoStr);
                        jogoItem.classList.add('selecionado');
                    } else {
                        jogosSelecionados.delete(jogoStr);
                        jogoItem.classList.remove('selecionado');
                    }
                    atualizarBotoesSeleção();
                });
                
                // Informações do jogo
                const jogoInfo = document.createElement('div');
                jogoInfo.className = 'jogo-info';
                
                // Números do jogo
                const jogoNumeros = document.createElement('div');
                jogoNumeros.className = 'jogo-numeros';
                
                jogo.numeros.forEach(num => {
                    const numeroSpan = document.createElement('span');
                    numeroSpan.className = 'jogo-numero';
                    numeroSpan.textContent = String(num).padStart(2, '0');
                    jogoNumeros.appendChild(numeroSpan);
                });
                
                // Mês, se houver
                if (jogo.mes) {
                    const mesSpan = document.createElement('span');
                    mesSpan.className = 'jogo-mes';
                    mesSpan.textContent = `| ${jogo.mes}`;
                    jogoNumeros.appendChild(mesSpan);
                }
                
                // Informação de dígitos usados
                const digitosInfo = document.createElement('div');
                digitosInfo.className = 'jogo-digitos';
                digitosInfo.innerHTML = `<span>Dígitos: <span class="digito-quantidade">${analiseDigitos.quantidade}</span> (${analiseDigitos.digitos.join(', ')})</span>`;
                
                jogoInfo.appendChild(jogoNumeros);
                jogoInfo.appendChild(digitosInfo);
                
                // Botões de ação
                const btnAnalisar = document.createElement('button');
                btnAnalisar.className = 'btn-analisar';
                btnAnalisar.innerHTML = '<i class="fas fa-search"></i>';
                btnAnalisar.title = 'Analisar dígitos deste jogo';
                btnAnalisar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    analisarDigitosJogoCarregado(jogo.numeros);
                });
                
                const btnRemover = document.createElement('button');
                btnRemover.className = 'btn-remover';
                btnRemover.textContent = 'Remover';
                btnRemover.addEventListener('click', () => removerJogo(jogo, jogoItem));
                
                const botoesContainer = document.createElement('div');
                botoesContainer.className = 'jogo-botoes';
                botoesContainer.appendChild(btnAnalisar);
                botoesContainer.appendChild(btnRemover);
                
                // Montar o item
                jogoItem.appendChild(checkbox);
                jogoItem.appendChild(jogoInfo);
                jogoItem.appendChild(botoesContainer);
                
                listaJogos.appendChild(jogoItem);
            }
            
            function removerJogo(jogo, jogoItem) {
                const index = jogosIncluidos.findIndex(j => 
                    JSON.stringify(j) === JSON.stringify(jogo)
                );
                
                if (index !== -1) {
                    jogosIncluidos.splice(index, 1);
                    jogosSelecionados.delete(JSON.stringify(jogo));
                    jogoItem.remove();
                    atualizarBotoesSeleção();
                    atualizarContadorJogos();
                    alert('1 jogo foi removido com sucesso!');
                }
            }
            
            function limparTodosJogos() {
                const quantidadeAtual = jogosIncluidos.length;
                if (quantidadeAtual === 0) {
                    alert('Não há jogos para remover');
                    return;
                }
                
                if (confirm('Tem certeza que deseja remover todos os jogos?')) {
                    jogosIncluidos.length = 0;
                    jogosSelecionados.clear();
                    document.getElementById('lista-jogos').innerHTML = '';
                    atualizarBotoesSeleção();
                    atualizarContadorJogos();
                    alert(`${quantidadeAtual} jogos foram removidos com sucesso!`);
                }
            }
            
            function removerJogosSelecionados() {
                if (jogosSelecionados.size === 0) {
                    alert('Selecione pelo menos um jogo para remover');
                    return;
                }
                
                const quantidadeRemover = jogosSelecionados.size;
                if (confirm(`Deseja remover ${quantidadeRemover} jogo${quantidadeRemover === 1 ? '' : 's'} selecionado${quantidadeRemover === 1 ? '' : 's'}?`)) {
                    jogosSelecionados.forEach(jogoStr => {
                        const jogo = JSON.parse(jogoStr);
                        const index = jogosIncluidos.findIndex(j => 
                            JSON.stringify(j) === jogoStr
                        );
                        
                        if (index !== -1) {
                            jogosIncluidos.splice(index, 1);
                        }
                    });
                    
                    document.querySelectorAll('.jogo-checkbox:checked').forEach(checkbox => {
                        checkbox.closest('.jogo-item').remove();
                    });
                    
                    jogosSelecionados.clear();
                    atualizarBotoesSeleção();
                    atualizarContadorJogos();
                    alert(`${quantidadeRemover} jogos foram removidos com sucesso!`);
                }
            }
            
            function atualizarBotoesSeleção() {
                const removerSelecionadosBtn = document.getElementById('btn-remover-selecionados');
                removerSelecionadosBtn.disabled = jogosSelecionados.size === 0;
                
                if (jogosSelecionados.size > 0) {
                    removerSelecionadosBtn.classList.add('btn-vermelho');
                } else {
                    removerSelecionadosBtn.classList.remove('btn-vermelho');
                }
            }
            
            // ===== FUNÇÕES DE PROCESSAMENTO DE ARQUIVOS =====
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function handleDrop(e) {
                const file = e.dataTransfer.files[0];
                processFile(file);
            }
            
            function handleFileSelect(e) {
                const file = e.target.files[0];
                processFile(file);
            }
            
            function processFile(file) {
                if (!file) return;
                
                const dropZone = document.getElementById('drop-zone');
                dropZone.classList.add('processing');
                
                if (file.name.endsWith('.txt')) {
                    processarArquivoTXT(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    processarArquivoXLSX(file);
                } else {
                    alert('Formato de arquivo não suportado. Use .txt ou .xlsx');
                    dropZone.classList.remove('processing');
                }
            }
            
            function processarArquivoTXT(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.trim().split('\n');
                        const jogos = [];
                        
                        for (const line of lines) {
                            try {
                                const partes = line.trim().split(/\s+/);
                                const numeros = [];
                                let mes = null;
                                
                                // Extrair os números e possível mês
                                for (let i = 0; i < partes.length; i++) {
                                    if (i < 7) {  // Primeiros 7 valores como números
                                        const num = parseInt(partes[i]);
                                        if (!isNaN(num) && num >= 1 && num <= 31) {
                                            numeros.push(num);
                                        }
                                    } else {  // O que vier depois pode ser o mês
                                        mes = normalizarMes(partes[i]);
                                        break;
                                    }
                                }
                                
                                // Verificar se o jogo é válido
                                if (numeros.length === 7 && new Set(numeros).size === 7 && 
                                    numeros.every(n => n >= 1 && n <= 31)) {
                                    jogos.push({
                                        numeros: numeros.sort((a, b) => a - b),
                                        mes: mes
                                    });
                                }
                            } catch (err) {
                                console.error(`Erro na linha: ${err.message}`);
                            }
                        }
                        
                        // Adicionar jogos à lista
                        adicionarJogosProcessados(jogos);
                        
                    } catch (err) {
                        console.error(`Erro ao processar TXT: ${err.message}`);
                        alert(`Erro ao processar arquivo: ${err.message}`);
                    } finally {
                        document.getElementById('drop-zone').classList.remove('processing');
                    }
                };
                
                reader.onerror = function() {
                    alert('Erro ao ler o arquivo');
                    document.getElementById('drop-zone').classList.remove('processing');
                };
                
                reader.readAsText(file);
            }
            
            function processarArquivoXLSX(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        const jogos = [];
                        
                        for (const row of rows) {
                            if (!row || row.length < 7) continue;
                            
                            const numeros = [];
                            
                            // Extrair os primeiros 7 valores como números
                            for (let i = 0; i < 7; i++) {
                                if (i < row.length) {
                                    const valor = row[i];
                                    const num = parseInt(valor);
                                    if (!isNaN(num) && num >= 1 && num <= 31) {
                                        numeros.push(num);
                                    }
                                }
                            }
                            
                            // Verificar se há uma coluna para o mês
                            let mes = null;
                            if (row.length > 7 && row[7]) {
                                mes = normalizarMes(String(row[7]));
                            }
                            
                            // Verificar se o jogo é válido
                            if (numeros.length === 7 && new Set(numeros).size === 7 && 
                                numeros.every(n => n >= 1 && n <= 31)) {
                                jogos.push({
                                    numeros: numeros.sort((a, b) => a - b),
                                    mes: mes
                                });
                            }
                        }
                        
                        // Adicionar jogos à lista
                        adicionarJogosProcessados(jogos);
                        
                    } catch (err) {
                        console.error(`Erro ao processar Excel: ${err.message}`);
                        alert(`Erro ao processar arquivo: ${err.message}`);
                    } finally {
                        document.getElementById('drop-zone').classList.remove('processing');
                    }
                };
                
                reader.onerror = function() {
                    alert('Erro ao ler o arquivo');
                    document.getElementById('drop-zone').classList.remove('processing');
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            function adicionarJogosProcessados(jogos) {
                if (!jogos || jogos.length === 0) {
                    alert('Nenhum jogo válido encontrado no arquivo');
                    return;
                }
                
                // Verificar jogos duplicados
                const jogosAtuais = new Set(jogosIncluidos.map(j => JSON.stringify(j)));
                let jogosNovos = 0;
                
                // Processar em lotes para evitar travamento da interface
                const BATCH_SIZE = 1000;
                const totalBatches = Math.ceil(jogos.length / BATCH_SIZE);
                
                function processarLote(batch) {
                    if (batch >= totalBatches) {
                        // Analisar dígitos do primeiro jogo carregado
                        if (jogos.length > 0 && jogos[0].numeros) {
                            analisarDigitosJogoCarregado(jogos[0].numeros);
                        }
                        
                        atualizarContadorJogos();
                        alert(`${jogosNovos} jogos foram incluídos com sucesso!`);
                        return;
                    }
                    
                    const startIdx = batch * BATCH_SIZE;
                    const endIdx = Math.min((batch + 1) * BATCH_SIZE, jogos.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const jogo = jogos[i];
                        const jogoStr = JSON.stringify(jogo);
                        if (!jogosAtuais.has(jogoStr)) {
                            jogosIncluidos.push(jogo);
                            adicionarJogoNaLista(jogo);
                            jogosAtuais.add(jogoStr);
                            jogosNovos++;
                        }
                    }
                    
                    // Processar o próximo lote de forma assíncrona
                    setTimeout(() => processarLote(batch + 1), 0);
                }
                
                // Iniciar o processamento
                processarLote(0);
            }
            
            // ===== FUNÇÕES DE ANÁLISE DE DÍGITOS =====
            
            function extrairDigitosUnicos(numeros) {
                const digitosSet = new Set();
                
                numeros.forEach(num => {
                    const numStr = String(num).padStart(2, '0');
                    for (let i = 0; i < numStr.length; i++) {
                        digitosSet.add(numStr[i]);
                    }
                });
                
                return {
                    digitos: Array.from(digitosSet).sort(),
                    quantidade: digitosSet.size
                };
            }
            
            function analisarDigitos() {
                const digitosAnalise = document.getElementById('digitos-analise');
                
                if (numerosSelecionados.size > 0) {
                    digitosAnalise.style.display = 'block';
                    
                    // Resetar todos os dígitos
                    for (let i = 0; i < 10; i++) {
                        const digitoEl = document.getElementById(`digito-${i}`);
                        digitoEl.classList.remove('digito-presente');
                    }
                    
                    // Analisar dígitos usados
                    const analiseDigitos = extrairDigitosUnicos(Array.from(numerosSelecionados));
                    
                    // Atualizar contagem de dígitos
                    document.getElementById('contador-digitos').textContent = analiseDigitos.quantidade;
                    
                    // Marcar dígitos presentes
                    analiseDigitos.digitos.forEach(digito => {
                        const digitoEl = document.getElementById(`digito-${digito}`);
                        if (digitoEl) {
                            digitoEl.classList.add('digito-presente');
                        }
                    });
                } else {
                    digitosAnalise.style.display = 'none';
                }
            }
            
            function analisarDigitosJogoCarregado(numeros) {
                const digitosAnalise = document.getElementById('digitos-analise');
                digitosAnalise.style.display = 'block';
                
                // Resetar todos os dígitos
                for (let i = 0; i < 10; i++) {
                    const digitoEl = document.getElementById(`digito-${i}`);
                    digitoEl.classList.remove('digito-presente');
                }
                
                // Análise de dígitos usados
                const analiseDigitos = extrairDigitosUnicos(numeros);
                
                // Atualizar contagem de dígitos
                document.getElementById('contador-digitos').textContent = analiseDigitos.quantidade;
                
                // Marcar dígitos presentes
                analiseDigitos.digitos.forEach(digito => {
                    const digitoEl = document.getElementById(`digito-${digito}`);
                    if (digitoEl) {
                        digitoEl.classList.add('digito-presente');
                    }
                });
            }
            
            function formatarDigitosUsados(numeros) {
                const resultado = extrairDigitosUnicos(numeros);
                return `<span class="digito-quantidade">${resultado.quantidade}</span> (${resultado.digitos.join(', ')})`;
            }
            
            // ===== FUNÇÕES DE CONFERÊNCIA =====
            
            async function buscarUltimoConcurso() {
                try {
                    // Tenta buscar o último concurso da API
                    for (const apiUrl of API_URLS) {
                        try {
                            const response = await fetch(`${apiUrl}/latest`);
                            if (response.ok) {
                                const data = await response.json();
                                if (data && data.concurso) {
                                    ultimoConcurso = parseInt(data.concurso);
                                    document.getElementById('fim').value = ultimoConcurso;
                                    return;
                                }
                            }
                        } catch (err) {
                            console.warn(`Falha ao buscar último concurso da API ${apiUrl}: ${err.message}`);
                        }
                    }
                    
                    // Se não conseguiu, usa o valor padrão
                    document.getElementById('fim').value = ultimoConcurso;
                    
                } catch (err) {
                    console.error(`Erro ao buscar último concurso: ${err.message}`);
                    document.getElementById('fim').value = ultimoConcurso;
                }
            }
            
            async function iniciarConferencia() {
                if (jogosIncluidos.length === 0) {
                    alert('Inclua pelo menos um jogo antes de conferir!');
                    return;
                }
                
                const inicio = parseInt(document.getElementById('inicio').value);
                const fim = parseInt(document.getElementById('fim').value);
                
                if (!inicio || !fim || inicio > fim) {
                    alert('Verifique os números dos concursos!');
                    return;
                }
                
                const overlay = document.getElementById('overlay');
                overlay.style.display = 'flex';
                conferenciaCancelada = false;
                
                // Resetar barra de progresso
                const progressFill = document.getElementById('progress-fill');
                progressFill.style.width = '0%';
                progressFill.style.backgroundColor = '';
                
                // Limpar logs anteriores
                const logsContainer = document.getElementById('progress-logs');
                logsContainer.innerHTML = '';
                
                // Adicionar mensagem inicial
                adicionarLog(`Iniciando conferência de ${jogosIncluidos.length} jogos nos concursos ${inicio} a ${fim}`);
                
                try {
                    // Definir total de lotes
                    const totalLotes = Math.ceil((fim - inicio + 1) / TAMANHO_LOTE);
                    adicionarLog(`Processamento dividido em ${totalLotes} lotes de concursos`);
                    
                    const resultados = await processarTodosJogos(inicio, fim, jogosIncluidos);
                    
                    if (conferenciaCancelada) {
                        adicionarLog('Operação cancelada pelo usuário');
                        return;
                    }
                    
                    // Garantir que a barra chegue a 100%
                    progressFill.style.width = '100%';
                    
                    // Mostrar resultados
                    mostrarResultados(resultados);
                    
                } catch (err) {
                    console.error(`Erro na conferência: ${err.message}`);
                    adicionarLog(`ERRO: ${err.message}`);
                    
                    // Mostrar erro na barra de progresso
                    progressFill.style.width = '100%';
                    progressFill.style.backgroundColor = '#dc3545';
                    
                    alert(`Ocorreu um erro: ${err.message}`);
                    
                } finally {
                    // Fechar overlay com pequeno delay
                    setTimeout(() => {
                        if (!conferenciaCancelada) {
                            overlay.style.display = 'none';
                        }
                        // Restaurar título original
                        document.title = 'Dia de Sorte Conferidor';
                    }, 1500);
                }
            }
            
            async function processarTodosJogos(inicio, fim, jogos) {
                const todosResultados = [];
                const totalLotes = Math.ceil((fim - inicio + 1) / TAMANHO_LOTE);
                let algumLoteBemSucedido = false;
                
                // Dividir os jogos em chunks para prevenir stack overflow
                const CHUNK_SIZE = Math.min(2000, Math.ceil(jogos.length / 10)); // Limitar a 2000 jogos por vez
                const jogosChunks = [];
                
                for (let i = 0; i < jogos.length; i += CHUNK_SIZE) {
                    jogosChunks.push(jogos.slice(i, i + CHUNK_SIZE));
                }
                
                adicionarLog(`Jogos divididos em ${jogosChunks.length} grupos para processamento otimizado`);
                
                for (let i = inicio; i <= fim; i += TAMANHO_LOTE) {
                    if (conferenciaCancelada) {
                        throw new Error('Operação cancelada pelo usuário');
                    }
                    
                    const loteAtual = Math.ceil((i - inicio + 1) / TAMANHO_LOTE);
                    const loteFim = Math.min(i + TAMANHO_LOTE - 1, fim);
                    
                    adicionarLog(`Processando lote ${loteAtual} de ${totalLotes}: concursos ${i} até ${loteFim}`);
                    atualizarProgressoConferencia(loteAtual, totalLotes, i, loteFim);
                    
                    let resultadosLote = [];
                    let loteProcessadoComSucesso = false;
                    
                    // Processar cada chunk de jogos separadamente
                    for (let chunkIndex = 0; chunkIndex < jogosChunks.length; chunkIndex++) {
                        if (conferenciaCancelada) {
                            throw new Error('Operação cancelada pelo usuário');
                        }
                        
                        try {
                            const jogosChunk = jogosChunks[chunkIndex];
                            adicionarLog(`Processando grupo ${chunkIndex + 1}/${jogosChunks.length} com ${jogosChunk.length} jogos`);
                            
                            const resultadosChunk = await processarLote(i, loteFim, jogosChunk);
                            resultadosLote.push(...resultadosChunk);
                            loteProcessadoComSucesso = true;
                            
                            // Pequena pausa entre chunks para liberar a UI thread
                            await new Promise(resolve => setTimeout(resolve, 50));
                            
                        } catch (err) {
                            adicionarLog(`Erro no grupo ${chunkIndex + 1}: ${err.message}. Continuando com o próximo grupo...`);
                            console.error(`Erro no processamento do grupo ${chunkIndex + 1}: ${err.message}`);
                            
                            // Pausar um pouco mais quando há erro
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    if (loteProcessadoComSucesso) {
                        todosResultados.push(...resultadosLote);
                        algumLoteBemSucedido = true;
                        adicionarLog(`Lote ${loteAtual} concluído. Encontrados ${resultadosLote.length} resultados.`);
                    } else {
                        adicionarLog(`Lote ${loteAtual} falhou completamente. Continuando com o próximo...`);
                    }
                    
                    // Limpar memória
                    resultadosLote = null;
                    // Forçar garbage collection quando disponível
                    if (window.gc) {
                        try {
                            window.gc();
                        } catch (e) {}
                    }
                    
                    // Pequena pausa entre lotes
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Se não conseguimos processar nenhum resultado, levanta uma exceção
                if (!algumLoteBemSucedido) {
                    throw new Error("Não foi possível processar nenhum resultado nos lotes de concursos.");
                }
                
                adicionarLog("Processamento de todos os lotes concluído com sucesso!");
                
                // Calcular resumo (com tratamento de erro)
                try {
                    const resumo = calcularResumo(todosResultados);
                    adicionarLog(`Total de acertos encontrados: 4: ${resumo.quatro}, 5: ${resumo.cinco}, 6: ${resumo.seis}, 7: ${resumo.sete}, mês: ${resumo.mes}`);
                    
                    // Processamento não-bloqueante para estatísticas de jogos
                    return {
                        acertos: todosResultados,
                        resumo: resumo,
                        jogos_stats: await processarEstatisticasJogosAsync(todosResultados, jogos)
                    };
                } catch (err) {
                    adicionarLog(`Erro ao calcular o resumo: ${err.message}. Tentando continuar...`);
                    // Retornar resultados mesmo com erro no resumo
                    return {
                        acertos: todosResultados,
                        resumo: {
                            quatro: 0, cinco: 0, seis: 0, sete: 0, mes: 0, total_premios: 0
                        },
                        jogos_stats: []
                    };
                }
            }
            
            async function processarLote(inicio, fim, jogos) {
                const resultados = [];
                const somentePremiados = document.getElementById('somente-premiados').checked;
                
                // Processar concursos em paralelo, mas limitado a 3 por vez para reduzir carga
                const concursos = [];
                for (let i = inicio; i <= fim; i++) {
                    concursos.push(i);
                }
                
                // Processar em chunks de 3 para não sobrecarregar
                const chunkSize = 3;
                for (let i = 0; i < concursos.length; i += chunkSize) {
                    if (conferenciaCancelada) {
                        throw new Error('Operação cancelada pelo usuário');
                    }
                    
                    const chunk = concursos.slice(i, i + chunkSize);
                    
                    // Usar Promise.allSettled para continuar mesmo se algumas promessas falharem
                    const promessas = chunk.map(concurso => buscarResultadoConcurso(concurso));
                    const resultadosPromessas = await Promise.allSettled(promessas);
                    
                    // Processar os resultados do chunk
                    const resultadosChunk = resultadosPromessas
                        .filter(r => r.status === 'fulfilled' && r.value)
                        .map(r => r.value);
                    
                    for (const resultado of resultadosChunk) {
                        // Para cada jogo, verificar o resultado
                        processarResultadoConcurso(resultado, jogos, somentePremiados, resultados);
                    }
                    
                    // Atualizar progresso dentro do lote
                    const percentualChunk = Math.round(((i + chunk.length) / concursos.length) * 100);
                    const progressText = document.getElementById('progress-text');
                    progressText.textContent = `Processando concursos ${chunk[0]} a ${chunk[chunk.length - 1]}... (${percentualChunk}% deste lote)`;
                    
                    // Pequena pausa para não sobrecarregar
                    await new Promise(resolve => setTimeout(resolve, 30));
                }
                
                return resultados;
            }
            
            // Função que processa o resultado do concurso sem recursão
            function processarResultadoConcurso(resultado, jogos, somentePremiados, resultados) {
                if (!resultado) return;
                
                const dezenas = resultado.dezenas.map(d => parseInt(d));
                const mesSorteado = resultado.mesDaSorte || '';
                
                // Processar cada jogo iterativamente
                for (let i = 0; i < jogos.length; i++) {
                    const jogo = jogos[i];
                    const acertosNumeros = contarAcertos(jogo.numeros, dezenas);
                    const acertouMes = jogo.mes && mesSorteado && 
                                      jogo.mes.toUpperCase() === mesSorteado.toUpperCase();
                    
                    // Verificar se deve incluir apenas premiados
                    if (somentePremiados && acertosNumeros < 4 && !acertouMes) {
                        continue;
                    }
                    
                    // Calcular prêmio
                    let premio = 0;
                    try {
                        premio = calcularPremio(resultado, acertosNumeros, acertouMes);
                    } catch (err) {
                        console.error(`Erro ao calcular prêmio: ${err.message}`);
                    }
                    
                    if (acertosNumeros >= 4 || acertouMes || !somentePremiados) {
                        resultados.push({
                            concurso: resultado.concurso,
                            data: resultado.data,
                            numeros_sorteados: dezenas,
                            mes_sorteado: mesSorteado,
                            seus_numeros: jogo.numeros,
                            seu_mes: jogo.mes,
                            acertos: acertosNumeros,
                            acertou_mes: acertouMes,
                            premio: premio
                        });
                    }
                }
            }
            
            async function buscarResultadoConcurso(concurso) {
                // Verificar cache primeiro
                if (resultadosCache[concurso]) {
                    return resultadosCache[concurso];
                }
                
                // Implementar timeout para as requisições
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Timeout ao buscar concurso')), 10000);
                });
                
                // Tentar em cada API disponível
                for (const apiUrl of API_URLS) {
                    try {
                        const fetchPromise = fetch(`${apiUrl}/${concurso}`);
                        const response = await Promise.race([fetchPromise, timeoutPromise]);
                        
                        if (response.ok) {
                            const data = await response.json();
                            apiFailureCount = 0; // Resetar contador de falhas
                            
                            // Verificar o formato da resposta e normalizar
                            let resultado;
                            
                            if ('dezenas' in data) {
                                // Formato da API principal
                                resultado = {
                                    concurso: data.concurso,
                                    data: data.data,
                                    dezenas: data.dezenas,
                                    mesDaSorte: data.mesDaSorte || '',
                                    premiacoes: data.premiacoes || []
                                };
                            } else if ('listaDezenas' in data) {
                                // Formato da API alternativa
                                resultado = {
                                    concurso: data.numero,
                                    data: data.dataApuracao,
                                    dezenas: data.listaDezenas,
                                    mesDaSorte: data.nomeTimeCoracaoMesSorte || '',
                                    premiacoes: []
                                };
                                
                                // Converter premiações
                                if ('listaRateioPremio' in data) {
                                    data.listaRateioPremio.forEach(premio => {
                                        resultado.premiacoes.push({
                                            descricao: premio.descricaoFaixa || '',
                                            ganhadores: premio.numeroDeGanhadores || 0,
                                            valorPremio: premio.valorPremio || 0
                                        });
                                    });
                                }
                            } else {
                                console.warn(`Formato desconhecido para concurso ${concurso}`);
                                continue; // Tenta a próxima API
                            }
                            
                            // Salvar no cache
                            resultadosCache[concurso] = resultado;
                            salvarCache();
                            
                            return resultado;
                        }
                    } catch (err) {
                        console.warn(`Erro ao buscar concurso ${concurso} da API ${apiUrl}: ${err.message}`);
                        apiFailureCount++;
                        
                        // Se houver muitas falhas consecutivas, fazer uma pausa
                        if (apiFailureCount > 5) {
                            apiFailureCount = 0; // Resetar o contador
                            await new Promise(resolve => setTimeout(resolve, 3000)); // Pausa de 3 segundos
                        }
                    }
                }
                
                // Se chegou aqui, não conseguiu obter de nenhuma API
                console.error(`Não foi possível obter o resultado do concurso ${concurso}`);
                return null;
            }
            
            // Função para processar estatísticas de jogos de forma assíncrona
            async function processarEstatisticasJogosAsync(resultados, jogos) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        try {
                            const estatisticas = calcularEstatisticasJogos(resultados, jogos);
                            resolve(estatisticas);
                        } catch (err) {
                            console.error(`Erro ao calcular estatísticas: ${err.message}`);
                            resolve([]); // Retornar array vazio em caso de erro
                        }
                    }, 10); // Delay mínimo para não bloquear a UI
                });
            }
            
            // ===== FUNÇÕES DE UTILITÁRIOS =====
            
            function normalizarMes(mes) {
                if (!mes) return null;
                
                const mesesMap = {
                    "JAN": "JANEIRO",
                    "FEV": "FEVEREIRO",
                    "MAR": "MARÇO", 
                    "ABR": "ABRIL",
                    "MAI": "MAIO",
                    "JUN": "JUNHO",
                    "JUL": "JULHO",
                    "AGO": "AGOSTO",
                    "SET": "SETEMBRO",
                    "OUT": "OUTUBRO",
                    "NOV": "NOVEMBRO",
                    "DEZ": "DEZEMBRO"
                };
                
                const mesUpper = mes.toUpperCase();
                
                // Se já for o nome completo
                if (MESES.includes(mesUpper)) {
                    return mesUpper;
                }
                
                // Se for abreviado
                if (mesesMap[mesUpper]) {
                    return mesesMap[mesUpper];
                }
                
                // Verificar se é uma abreviação de 3 letras para qualquer mês
                for (const [abrev, completo] of Object.entries(mesesMap)) {
                    if (completo.startsWith(mesUpper)) {
                        return completo;
                    }
                }
                
                return mesUpper;
            }
            
            function contarAcertos(numerosJogo, numerosSorteados) {
                return numerosJogo.filter(n => numerosSorteados.includes(n)).length;
            }
            
            function calcularPremio(resultado, acertos, acertouMes = false) {
                let premio = 0;
                if ('premiacoes' in resultado) {
                    try {
                        resultado.premiacoes.forEach(premiacao => {
                            if ((acertos === 7 && premiacao.descricao === '7 acertos') ||
                                (acertos === 6 && premiacao.descricao === '6 acertos') ||
                                (acertos === 5 && premiacao.descricao === '5 acertos') ||
                                (acertos === 4 && premiacao.descricao === '4 acertos') ||
                                (acertouMes && premiacao.descricao === 'Mês da Sorte')) {
                                premio += premiacao.valorPremio;
                            }
                        });
                    } catch (err) {
                        console.error(`Erro ao calcular prêmio: ${err.message}`);
                    }
                }
                return premio;
            }
            
            function calcularResumo(resultados) {
                const quatro = resultados.filter(r => r.acertos === 4).length;
                const cinco = resultados.filter(r => r.acertos === 5).length;
                const seis = resultados.filter(r => r.acertos === 6).length;
                const sete = resultados.filter(r => r.acertos === 7).length;
                const mes = resultados.filter(r => r.acertou_mes).length;
                
                const total_premios = resultados.reduce((sum, r) => sum + r.premio, 0);
                
                return {
                    quatro,
                    cinco,
                    seis,
                    sete,
                    mes,
                    total_premios
                };
            }
            
            function calcularEstatisticasJogos(resultados, jogos) {
                try {
                    const jogosStats = {};
                    
                    // Mapear todos os resultados dos concursos
                    for (let i = 0; i < resultados.length; i++) {
                        const resultado = resultados[i];
                        const concurso = resultado.concurso;
                        const numerosSorteados = resultado.numeros_sorteados;
                        const mesSorteado = resultado.mes_sorteado || '';
                        
                        // Para cada jogo do usuário, calcular acertos
                        for (let j = 0; j < jogos.length; j++) {
                            const jogo = jogos[j];
                            const numerosJogo = JSON.stringify(jogo.numeros.sort((a, b) => a - b));
                            const mesJogo = jogo.mes || '';
                            
                            // Criar entrada para este jogo se não existir
                            if (!jogosStats[numerosJogo]) {
                                jogosStats[numerosJogo] = {
                                    numeros: jogo.numeros,
                                    total: 0,
                                    distribuicao: {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0},
                                    acertos_mes: 0
                                };
                            }
                            
                            // Calcular acertos para este jogo neste concurso
                            const acertos = contarAcertos(jogo.numeros, numerosSorteados);
                            const acertouMes = mesJogo && mesSorteado && 
                                              mesJogo.toUpperCase() === mesSorteado.toUpperCase();
                            
                            // Atualizar estatísticas
                            if (acertos > 0) {
                                jogosStats[numerosJogo].total += 1;
                                jogosStats[numerosJogo].distribuicao[acertos] += 1;
                            }
                            
                            if (acertouMes) {
                                jogosStats[numerosJogo].acertos_mes += 1;
                            }
                        }
                    }
                    
                    // Converter para array e ordenar
                    const resultado = Object.values(jogosStats);
                    resultado.sort((a, b) => b.total - a.total);
                    
                    return resultado;
                } catch (err) {
                    console.error(`Erro em calcularEstatisticasJogos: ${err.message}`);
                    return [];
                }
            }
            
            function gerarNumerosAleatorios(min, max, quantidade) {
                const numeros = [];
                while (numeros.length < quantidade) {
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!numeros.includes(num)) {
                        numeros.push(num);
                    }
                }
                return numeros.sort((a, b) => a - b);
            }
            
            function formatarData(dataStr) {
                if (!dataStr) return '-';
                
                try {
                    // Transformar a data em um formato melhor
                    const parts = dataStr.split('/');
                    if (parts.length === 3) {
                        const day = parts[0].padStart(2, '0');
                        const month = parts[1].padStart(2, '0');
                        const year = parts[2];
                        return `${day}/${month}/${year}`;
                    }
                    return dataStr;
                } catch (err) {
                    return dataStr;
                }
            }
            
            function formatarValor(valor) {
                return valor > 0 ? 
                    `R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : 
                    'Não houve ganhadores';
            }
            
            function adicionarLog(mensagem) {
                const logsContainer = document.getElementById('progress-logs');
                
                const agora = new Date();
                const timestamp = `${agora.getHours().toString().padStart(2, '0')}:${agora.getMinutes().toString().padStart(2, '0')}:${agora.getSeconds().toString().padStart(2, '0')}`;
                
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.innerHTML = `<span class="log-time">${timestamp}</span> ${mensagem}`;
                
                logsContainer.insertBefore(logItem, logsContainer.firstChild);
                
                // Limitar a 10 mensagens para não sobrecarregar o DOM
                while (logsContainer.children.length > 10) {
                    logsContainer.removeChild(logsContainer.lastChild);
                }
                
                // Atualizar texto principal
                const progressText = document.getElementById('progress-text');
                progressText.textContent = mensagem;
            }
            
            function atualizarProgressoConferencia(loteAtual, totalLotes, concursoInicio, concursoFim) {
                const progressFill = document.getElementById('progress-fill');
                document.getElementById('lote-atual').textContent = loteAtual;
                document.getElementById('total-lotes').textContent = totalLotes;
                document.getElementById('concurso-atual').textContent = concursoInicio;
                document.getElementById('concurso-fim').textContent = concursoFim;
                
                // Calcular porcentagem
                const progresso = (loteAtual / totalLotes) * 100;
                
                // Atualizar barra de progresso
                progressFill.style.width = `${progresso}%`;
                progressFill.classList.add('animando');
                
                // Atualizar log
                adicionarLog(`Processando concursos ${concursoInicio} a ${concursoFim} (${Math.round(progresso)}% concluído)`);
                
                // Atualizar título da página
                document.title = `(${Math.round(progresso)}%) Dia de Sorte Conferidor`;
            }
            
            // ===== FUNÇÕES DE GERENCIAMENTO DE CACHE =====
            
            function salvarCache() {
                try {
                    // Limitar o cache para não sobrecarregar o localStorage
                    const cacheKeys = Object.keys(resultadosCache);
                    if (cacheKeys.length > 500) {
                        // Remover os itens mais antigos
                        const keysToRemove = cacheKeys.slice(0, cacheKeys.length - 500);
                        keysToRemove.forEach(key => delete resultadosCache[key]);
                    }
                    
                    localStorage.setItem('diaSorteResultadosCache', JSON.stringify(resultadosCache));
                } catch (err) {
                    console.warn(`Erro ao salvar cache: ${err.message}`);
                }
            }
            
            function carregarCache() {
                try {
                    const cache = localStorage.getItem('diaSorteResultadosCache');
                    if (cache) {
                        Object.assign(resultadosCache, JSON.parse(cache));
                        console.log(`Cache carregado com ${Object.keys(resultadosCache).length} resultados`);
                    }
                } catch (err) {
                    console.warn(`Erro ao carregar cache: ${err.message}`);
                }
            }
            
            // ===== FUNÇÕES DE APRESENTAÇÃO DE RESULTADOS =====
            
            function mostrarResultados(data) {
                // Mostrar seção de resultados
                document.getElementById('resultados').style.display = 'block';
                
                // Atualizar contadores
                document.getElementById('quatro-acertos').textContent = data.resumo.quatro;
                document.getElementById('cinco-acertos').textContent = data.resumo.cinco;
                document.getElementById('seis-acertos').textContent = data.resumo.seis;
                document.getElementById('sete-acertos').textContent = data.resumo.sete;
                document.getElementById('mes-acertos').textContent = data.resumo.mes;
                
                // Atualizar valores de prêmios
                const calcularTotalPremios = (acertos) => {
                    return data.acertos
                        .filter(r => r.acertos === acertos)
                        .reduce((sum, r) => sum + r.premio, 0);
                };
                
                document.getElementById('quatro-valor').textContent = formatarValor(calcularTotalPremios(4));
                document.getElementById('cinco-valor').textContent = formatarValor(calcularTotalPremios(5));
                document.getElementById('seis-valor').textContent = formatarValor(calcularTotalPremios(6));
                document.getElementById('sete-valor').textContent = formatarValor(calcularTotalPremios(7));
                document.getElementById('mes-valor').textContent = formatarValor(
                    data.acertos
                        .filter(r => r.acertou_mes)
                        .reduce((sum, r) => sum + r.premio, 0)
                );
                
                // Atualizar detalhes e tabelas de forma não-bloqueante
                setTimeout(() => {
                    atualizarDetalhesETabela(data);
                    
                    if (data.jogos_stats && data.jogos_stats.length > 0) {
                        atualizarTabelaJogosSorteados(data.jogos_stats);
                        document.getElementById('jogos-mais-sorteados').style.display = 'block';
                    } else {
                        document.getElementById('jogos-mais-sorteados').style.display = 'none';
                    }
                    
                    // Mostrar botões de exportação
                    document.getElementById('export-resumo').classList.remove('hidden');
                    document.getElementById('export-jogos').classList.remove('hidden');
                    
                    if (data.jogos_stats && data.jogos_stats.length > 0) {
                        document.getElementById('export-estatisticas').classList.remove('hidden');
                    } else {
                        document.getElementById('export-estatisticas').classList.add('hidden');
                    }
                    
                    // Scrollar para os resultados
                    document.getElementById('resultados').scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                // Salvar dados para exportação
                dadosUltimaConsulta = data;
            }
            
            function atualizarDetalhesETabela(data) {
                const detalhesDiv = document.getElementById('detalhes-resultados');
                const tabelaBody = document.getElementById('tabela-resultados');
                
                detalhesDiv.innerHTML = '';
                tabelaBody.innerHTML = '';
                
                if (!data.acertos || data.acertos.length === 0) {
                    detalhesDiv.innerHTML = '<div class="sem-resultados">Nenhum prêmio encontrado para os jogos selecionados.</div>';
                    
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 10;
                    td.textContent = 'Nenhum prêmio encontrado.';
                    td.style.textAlign = 'center';
                    td.style.padding = '20px';
                    tr.appendChild(td);
                    tabelaBody.appendChild(tr);
                    
                    // Zerar o total
                    document.querySelector('.total-premios').textContent = 'R$ 0,00';
                    return;
                }
                
                // Limitar a 1000 resultados para evitar travamento do navegador
                const MAX_RESULTADOS = 1000;
                
                // Ordenar por concurso (decrescente) e depois por acertos (decrescente)
                const acertosOrdenados = [...data.acertos]
                    .sort((a, b) => {
                        if (b.concurso !== a.concurso) return b.concurso - a.concurso;
                        return b.acertos - a.acertos;
                    })
                    .slice(0, MAX_RESULTADOS);
                
                if (acertosOrdenados.length < data.acertos.length) {
                    adicionarLog(`Mostrando apenas ${MAX_RESULTADOS} de ${data.acertos.length} resultados para melhor desempenho.`);
                }
                
                // Processar em lotes para não bloquear a UI
                const LOTE_SIZE = 100;
                let loteAtual = 0;
                
                function processarLoteResultados() {
                    const inicio = loteAtual * LOTE_SIZE;
                    const fim = Math.min((loteAtual + 1) * LOTE_SIZE, acertosOrdenados.length);
                    
                    if (inicio >= acertosOrdenados.length) {
                        // Atualizar o total no rodapé
                        const totalCell = document.querySelector('.total-premios');
                        if (totalCell && data.resumo.total_premios) {
                            totalCell.textContent = formatarValor(data.resumo.total_premios);
                        }
                        return;
                    }
                    
                    const fragmento = document.createDocumentFragment();
                    
                    for (let i = inicio; i < fim; i++) {
                        const resultado = acertosOrdenados[i];
                        
                        // Análise de dígitos
                        const analiseDigitos = extrairDigitosUnicos(resultado.seus_numeros);
                        
                        // Informações do mês
                        const mesSorteado = resultado.mes_sorteado || 'Não informado';
                        const seuMes = resultado.seu_mes || 'Não informado';
                        
                        // Adicionar na tabela
                        const row = document.createElement('tr');
                        
                        // Formatar números para a tabela
                        const numerosSorteados = resultado.numeros_sorteados
                            .sort((a, b) => a - b)
                            .map(n => `<span class="numero-tabela">${String(n).padStart(2, '0')}</span>`)
                            .join(' ');
                            
                        const seusNumeros = resultado.seus_numeros
                            .sort((a, b) => a - b)
                            .map(n => `<span class="numero-tabela ${resultado.numeros_sorteados.includes(n) ? 'acerto' : ''}">${String(n).padStart(2, '0')}</span>`)
                            .join(' ');
                            
                        const premioText = resultado.premio > 0 
                            ? `R$ ${resultado.premio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` 
                            : 'Não houve ganhadores';
                        
                        row.innerHTML = `
                            <td>${resultado.concurso}</td>
                            <td>${formatarData(resultado.data)}</td>
                            <td><div class="numeros-tabela">${numerosSorteados}</div></td>
                            <td>${mesSorteado}</td>
                            <td><div class="numeros-tabela">${seusNumeros}</div></td>
                            <td>${seuMes}</td>
                            <td>${resultado.acertos}${resultado.acertou_mes ? ' + Mês' : ''}</td>
                            <td>${formatarDigitosUsados(resultado.seus_numeros)}</td>
                            <td>${premioText}</td>
                            <td>${resultado.premio > 0 ? 'Premiado' : 'Acumulado'}</td>
                        `;
                        
                        fragmento.appendChild(row);
                    }
                    
                    tabelaBody.appendChild(fragmento);
                    loteAtual++;
                    
                    // Processar próximo lote de forma não-bloqueante
                    setTimeout(processarLoteResultados, 5);
                }
                
                // Iniciar processamento
                processarLoteResultados();
            }
            
            function atualizarTabelaJogosSorteados(jogos_stats) {
                const tbody = document.querySelector('#tabela-jogos-sorteados tbody');
                tbody.innerHTML = '';
                
                if (!jogos_stats || jogos_stats.length === 0) {
                    document.getElementById('jogos-mais-sorteados').style.display = 'none';
                    return;
                }
                
                // Limitar a 20 jogos para melhor desempenho
                const jogosMostrar = jogos_stats.slice(0, 20);
                
                // Criar fragmento para melhor desempenho
                const fragmento = document.createDocumentFragment();
                
                jogosMostrar.forEach(jogo => {
                    const tr = document.createElement('tr');
                    
                    // Números do jogo
                    const tdJogo = document.createElement('td');
                    tdJogo.innerHTML = `<div class="numeros-tabela">
                        ${jogo.numeros.map(n => 
                            `<span class="numero-tabela">${String(n).padStart(2, '0')}</span>`
                        ).join(' ')}
                    </div>`;
                    
                    // Total de acertos
                    const tdTotal = document.createElement('td');
                    tdTotal.textContent = `${jogo.total} vezes`;
                    
                    // Distribuição de acertos
                    const tdDistribuicao = document.createElement('td');
                    const distribuicao = [];
                    for (let i = 1; i <= 7; i++) {
                        if (jogo.distribuicao[i] > 0) {
                            distribuicao.push(
                                `<span class="distribuicao-badge">
                                    ${i} ponto${i !== 1 ? 's' : ''}: ${jogo.distribuicao[i]} vez${jogo.distribuicao[i] !== 1 ? 'es' : ''}
                                </span>`
                            );
                        }
                    }
                    tdDistribuicao.innerHTML = distribuicao.join(' ');
                    
                    // Acertos do mês
                    const tdMes = document.createElement('td');
                    tdMes.textContent = jogo.acertos_mes > 0 ? `${jogo.acertos_mes} vezes` : '-';
                    
                    tr.appendChild(tdJogo);
                    tr.appendChild(tdTotal);
                    tr.appendChild(tdDistribuicao);
                    tr.appendChild(tdMes);
                    fragmento.appendChild(tr);
                });
                
                tbody.appendChild(fragmento);
            }
            
            // ===== FUNÇÕES DE EXPORTAÇÃO =====
            
            window.exportarExcel = function(tipo) {
                if (!dadosUltimaConsulta) {
                    alert('Faça uma consulta primeiro antes de exportar os dados.');
                    return;
                }
                
                try {
                    let dados = [];
                    let nomeArquivo = '';
                    
                    if (tipo === 'resumo-acertos') {
                        dados = [
                            ['Quantidade de Acertos', 'Total', 'Prêmio Total'],
                            ['4 acertos', dadosUltimaConsulta.resumo.quatro, calcularPremioTotal(4)],
                            ['5 acertos', dadosUltimaConsulta.resumo.cinco, calcularPremioTotal(5)],
                            ['6 acertos', dadosUltimaConsulta.resumo.seis, calcularPremioTotal(6)],
                            ['7 acertos', dadosUltimaConsulta.resumo.sete, calcularPremioTotal(7)],
                            ['Mês da Sorte', dadosUltimaConsulta.resumo.mes, calcularPremioTotalMes()]
                        ];
                        nomeArquivo = 'resumo-acertos.xlsx';
                    }
                    else if (tipo === 'jogos-premiados') {
                        dados = [
                            ['Concurso', 'Data', 'Números Sorteados', 'Mês Sorteado', 'Seus Números', 'Seu Mês', 'Acertos', 'Acertou Mês', 'Prêmio']
                        ];
                        
                        // Limitar a 50.000 linhas para não sobrecarregar a memória
                        const resultadosExportar = dadosUltimaConsulta.acertos.slice(0, 50000);
                        
                        resultadosExportar.forEach(r => {
                            dados.push([
                                r.concurso,
                                formatarData(r.data),
                                r.numeros_sorteados.join(' '),
                                r.mes_sorteado || '',
                                r.seus_numeros.join(' '),
                                r.seu_mes || '',
                                r.acertos,
                                r.acertou_mes ? 'Sim' : 'Não',
                                r.premio
                            ]);
                        });
                        
                        nomeArquivo = 'jogos-premiados.xlsx';
                    }
                    else if (tipo === 'jogos-sorteados') {
                        if (!dadosUltimaConsulta.jogos_stats) {
                            alert('Dados de estatísticas não disponíveis');
                            return;
                        }
                        
                        dados = [
                            ['Números', 'Total de Acertos', 'Distribuição', 'Acertos do Mês']
                        ];
                        
                        // Limitar a 10.000 jogos para a exportação
                        const jogosExportar = dadosUltimaConsulta.jogos_stats.slice(0, 10000);
                        
                        jogosExportar.forEach(jogo => {
                            const distribuicao = [];
                            for (let i = 1; i <= 7; i++) {
                                if (jogo.distribuicao[i] > 0) {
                                    distribuicao.push(`${i} pontos: ${jogo.distribuicao[i]}x`);
                                }
                            }
                            
                            dados.push([
                                jogo.numeros.join(' '),
                                jogo.total,
                                distribuicao.join(', '),
                                jogo.acertos_mes || 0
                            ]);
                        });
                        
                        nomeArquivo = 'jogos-sorteados.xlsx';
                    }
                    else {
                        alert('Tipo de exportação inválido');
                        return;
                    }
                    
                    // Criar planilha e workbook
                    const ws = XLSX.utils.aoa_to_sheet(dados);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Dia de Sorte");
                    
                    // Exportar arquivo
                    XLSX.writeFile(wb, nomeArquivo);
                    
                } catch (err) {
                    console.error(`Erro ao exportar Excel: ${err.message}`);
                    alert(`Erro ao exportar dados: ${err.message}`);
                }
            };
            
            function calcularPremioTotal(acertos) {
                return dadosUltimaConsulta.acertos
                    .filter(r => r.acertos === acertos)
                    .reduce((sum, r) => sum + r.premio, 0);
            }
            
            function calcularPremioTotalMes() {
                return dadosUltimaConsulta.acertos
                    .filter(r => r.acertou_mes)
                    .reduce((sum, r) => sum + r.premio, 0);
            }
        });
    </script>


</body>
</html>